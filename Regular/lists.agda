module lists where

open import Agda.Primitive using (Level; lzero; lsuc; _âŠ”_) public
open import Relation.Binary.PropositionalEquality
  renaming (cong to ap; sym to _â»Â¹; subst to tr) hiding ([_]) public
open â‰¡-Reasoning public
open import Function public

Type : (â„“ : Level) â†’ Set (lsuc â„“)
Type â„“ = Set â„“

private
  variable
    â„“ â„“â‚ â„“â‚‚ â„“â‚ƒ â„“â‚„ â„“â‚… â„“â‚† : Level

-- We define the basic data structures used to build contextual categories.

-- ğ¶ğ‘¡ğ‘¥ is a (reversed) list former
infixl 20 _âŠ¹_
data ğ¶ğ‘¡ğ‘¥ (ty : Type â„“) : Type â„“ where
  âˆ… : ğ¶ğ‘¡ğ‘¥ ty
  _âŠ¹_ : ğ¶ğ‘¡ğ‘¥ ty â†’ ty â†’ ğ¶ğ‘¡ğ‘¥ ty

mapğ¶ğ‘¡ğ‘¥ : {tyâ‚ : Type â„“â‚} {tyâ‚‚ : Type â„“â‚‚} (f : tyâ‚ â†’ tyâ‚‚) (Î“ : ğ¶ğ‘¡ğ‘¥ tyâ‚) â†’ ğ¶ğ‘¡ğ‘¥ tyâ‚‚
mapğ¶ğ‘¡ğ‘¥ f âˆ… = âˆ…
mapğ¶ğ‘¡ğ‘¥ f (Î“ âŠ¹ A) = mapğ¶ğ‘¡ğ‘¥ f Î“ âŠ¹ f A

-- ğ‘‡ğ‘šğ‘  forms indexed lists representing substitutions (terms of given types in a common context)
infixl 20 _âŠ•_
data ğ‘‡ğ‘šğ‘  {ty : Type â„“â‚} (tm : ğ¶ğ‘¡ğ‘¥ ty â†’ ty â†’ Type â„“â‚‚)
     : (Î“ Î” : ğ¶ğ‘¡ğ‘¥ ty) â†’ Type (â„“â‚ âŠ” â„“â‚‚) where
  ! : {Î“ : ğ¶ğ‘¡ğ‘¥ ty} â†’ ğ‘‡ğ‘šğ‘  tm Î“ âˆ…
  _âŠ•_ : {Î“ Î” : ğ¶ğ‘¡ğ‘¥ ty} {A : ty} â†’ ğ‘‡ğ‘šğ‘  tm Î“ Î” â†’ tm Î“ A â†’ ğ‘‡ğ‘šğ‘  tm Î“ (Î” âŠ¹ A)

mapğ‘‡ğ‘šğ‘  : {ty : Type â„“â‚} {Î“â‚ Î“â‚‚ Î” : ğ¶ğ‘¡ğ‘¥ ty} {tmâ‚ : ğ¶ğ‘¡ğ‘¥ ty â†’ ty â†’ Type â„“â‚‚}
  {tmâ‚‚ : ğ¶ğ‘¡ğ‘¥ ty â†’ ty â†’ Type â„“â‚ƒ} (f : {A : ty} â†’ tmâ‚ Î“â‚ A â†’ tmâ‚‚ Î“â‚‚ A)
  (Ïƒ : ğ‘‡ğ‘šğ‘  tmâ‚ Î“â‚ Î”) â†’ ğ‘‡ğ‘šğ‘  tmâ‚‚ Î“â‚‚ Î”
mapğ‘‡ğ‘šğ‘  f ! = !
mapğ‘‡ğ‘šğ‘  f (Ïƒ âŠ• t) = mapğ‘‡ğ‘šğ‘  f Ïƒ âŠ• f t

{-proveğ‘‡ğ‘šğ‘  : {ty : Type â„“â‚} {Î“â‚ Î“â‚‚ Î” : ğ¶ğ‘¡ğ‘¥ ty} {tm : ğ¶ğ‘¡ğ‘¥ ty â†’ ty â†’ Type â„“â‚‚}
  {f g : {A : ty} â†’ tm Î“â‚ A â†’ tm Î“â‚‚ A} (p : {A : ty} (t : tm Î“â‚ A) â†’ f t â‰¡ g t)
  (Ïƒ : ğ‘‡ğ‘šğ‘  tm Î“â‚ Î”) â†’ mapğ‘‡ğ‘šğ‘  {tmâ‚‚ = tm} f Ïƒ â‰¡ mapğ‘‡ğ‘šğ‘  g Ïƒ
proveğ‘‡ğ‘šğ‘  p ! = refl
proveğ‘‡ğ‘šğ‘  {f = f} {g} p (Ïƒ âŠ• t) =
  mapğ‘‡ğ‘šğ‘  f Ïƒ âŠ• f t
    â‰¡âŸ¨ ap (mapğ‘‡ğ‘šğ‘  f Ïƒ âŠ•_) (p t) âŸ©
  mapğ‘‡ğ‘šğ‘  f Ïƒ âŠ• g t
    â‰¡âŸ¨ ap (_âŠ• g t) (proveğ‘‡ğ‘šğ‘  p Ïƒ) âŸ©
  mapğ‘‡ğ‘šğ‘  g Ïƒ âŠ• g t
    âˆ-}

Ï€ğ‘‡ğ‘šğ‘  : {ty : Type â„“â‚} {tm : ğ¶ğ‘¡ğ‘¥ ty â†’ ty â†’ Type â„“â‚‚} {Î“ Î” : ğ¶ğ‘¡ğ‘¥ ty} {A : ty}
  â†’ ğ‘‡ğ‘šğ‘  tm Î“ (Î” âŠ¹ A) â†’ ğ‘‡ğ‘šğ‘  tm Î“ Î”
Ï€ğ‘‡ğ‘šğ‘  (Ïƒ âŠ• t) = Ïƒ

ğ‘§ğ‘‡ğ‘šğ‘  : {ty : Type â„“â‚} {tm : ğ¶ğ‘¡ğ‘¥ ty â†’ ty â†’ Type â„“â‚‚} {Î“ Î” : ğ¶ğ‘¡ğ‘¥ ty} {A : ty}
  â†’ ğ‘‡ğ‘šğ‘  tm Î“ (Î” âŠ¹ A) â†’ tm Î“ A
ğ‘§ğ‘‡ğ‘šğ‘  (Ïƒ âŠ• t) = t

mapğ‘‡ğ‘šğ‘ comp : {ty : Type â„“â‚} {tmâ‚ : ğ¶ğ‘¡ğ‘¥ ty â†’ ty â†’ Type â„“â‚‚} {tmâ‚‚ : ğ¶ğ‘¡ğ‘¥ ty â†’ ty â†’ Type â„“â‚ƒ}
  {tmâ‚ƒ : ğ¶ğ‘¡ğ‘¥ ty â†’ ty â†’ Type â„“â‚„} {Î“â‚ Î“â‚‚ Î“â‚ƒ Î” : ğ¶ğ‘¡ğ‘¥ ty} (f : {A : ty} â†’ tmâ‚‚ Î“â‚‚ A â†’ tmâ‚ƒ Î“â‚ƒ A)
  (g : {A : ty} â†’ tmâ‚ Î“â‚ A â†’ tmâ‚‚ Î“â‚‚ A) (Ïƒ : ğ‘‡ğ‘šğ‘  tmâ‚ Î“â‚ Î”) â†’
  mapğ‘‡ğ‘šğ‘  {tmâ‚ = tmâ‚‚} {tmâ‚‚ = tmâ‚ƒ} f (mapğ‘‡ğ‘šğ‘  g Ïƒ) â‰¡ mapğ‘‡ğ‘šğ‘  (f âˆ˜ g) Ïƒ
mapğ‘‡ğ‘šğ‘ comp f g ! = refl
mapğ‘‡ğ‘šğ‘ comp {tmâ‚‚ = tmâ‚‚} {Î“â‚‚ = Î“â‚‚} f g (Ïƒ âŠ• t) = ap (_âŠ• f (g t)) (mapğ‘‡ğ‘šğ‘ comp f g Ïƒ)

-- Variables
data ğ‘‰ğ‘ğ‘Ÿ (ty : Type â„“) : (Î“ : ğ¶ğ‘¡ğ‘¥ ty) (A : ty) â†’ Type â„“ where
  ğ‘§ğ‘£ : {Î“ : ğ¶ğ‘¡ğ‘¥ ty} {A : ty} â†’ ğ‘‰ğ‘ğ‘Ÿ ty (Î“ âŠ¹ A) A
  ğ‘ ğ‘£ : {Î“ : ğ¶ğ‘¡ğ‘¥ ty} {A B : ty} â†’ ğ‘‰ğ‘ğ‘Ÿ ty Î“ A â†’ ğ‘‰ğ‘ğ‘Ÿ ty (Î“ âŠ¹ B) A

ğ‘…ğ‘’ğ‘› : (ty : Type â„“) â†’ ğ¶ğ‘¡ğ‘¥ ty â†’ ğ¶ğ‘¡ğ‘¥ ty â†’ Type â„“
ğ‘…ğ‘’ğ‘› ty = ğ‘‡ğ‘šğ‘  (ğ‘‰ğ‘ğ‘Ÿ ty)

module _ {ty : Type â„“} where
  private
    ctx = ğ¶ğ‘¡ğ‘¥ ty
    ren = ğ‘…ğ‘’ğ‘› ty
    var = ğ‘‰ğ‘ğ‘Ÿ ty
  
  Wâ‚ğ‘…ğ‘’ğ‘› : {Î“ Î” : ctx} (A : ty) â†’ ren Î“ Î” â†’ ren (Î“ âŠ¹ A) Î”
  Wâ‚ğ‘…ğ‘’ğ‘› A = mapğ‘‡ğ‘šğ‘  ğ‘ ğ‘£

  Wâ‚‚ğ‘…ğ‘’ğ‘› : {Î“ Î” : ctx} (A : ty) â†’ ren Î“ Î” â†’ ren (Î“ âŠ¹ A) (Î” âŠ¹ A)
  Wâ‚‚ğ‘…ğ‘’ğ‘› A Ïƒ = Wâ‚ğ‘…ğ‘’ğ‘› A Ïƒ âŠ• ğ‘§ğ‘£

  idğ‘…ğ‘’ğ‘› : (Î“ : ctx) â†’ ren Î“ Î“
  idğ‘…ğ‘’ğ‘› âˆ… = !
  idğ‘…ğ‘’ğ‘› (Î“ âŠ¹ A) = Wâ‚‚ğ‘…ğ‘’ğ‘› A (idğ‘…ğ‘’ğ‘› Î“)

  infix 30 _[_]ğ‘…
  _[_]ğ‘… : {Î“ Î” : ctx} {A : ty} â†’ var Î” A â†’ ren Î“ Î” â†’ var Î“ A
  ğ‘§ğ‘£ [ Ïƒ âŠ• v ]ğ‘… = v
  ğ‘ ğ‘£ v [ Ïƒ âŠ• w ]ğ‘… = v [ Ïƒ ]ğ‘…

  infixl 30 _âˆ˜ğ‘…ğ‘’ğ‘›_
  _âˆ˜ğ‘…ğ‘’ğ‘›_ : {Î“ Î” Î£ : ctx} â†’ ren Î” Î£ â†’ ren Î“ Î” â†’ ren Î“ Î£
  Ïƒ âˆ˜ğ‘…ğ‘’ğ‘› Ï„ = mapğ‘‡ğ‘šğ‘  _[ Ï„ ]ğ‘… Ïƒ

  Wlem1ğ‘…ğ‘’ğ‘› : {Î“ Î” Î£ : ctx} {A : ty} (Ïƒ : ren Î” Î£) (Ï„ : ren Î“ Î”) (v : var Î“ A) â†’
    Wâ‚ğ‘…ğ‘’ğ‘› A Ïƒ âˆ˜ğ‘…ğ‘’ğ‘› (Ï„ âŠ• v) â‰¡ Ïƒ âˆ˜ğ‘…ğ‘’ğ‘› Ï„
  Wlem1ğ‘…ğ‘’ğ‘› ! Ï„ v = refl
  Wlem1ğ‘…ğ‘’ğ‘› (Ïƒ âŠ• w) Ï„ v = ap (_âŠ• w [ Ï„ ]ğ‘…) (Wlem1ğ‘…ğ‘’ğ‘› Ïƒ Ï„ v)

  Wlem2ğ‘…ğ‘’ğ‘› : {Î“ Î” : ctx} {A B : ty} (v : var Î” A) (Ïƒ : ren Î“ Î”) â†’
    v [ Wâ‚ğ‘…ğ‘’ğ‘› B Ïƒ ]ğ‘… â‰¡ ğ‘ ğ‘£ (v [ Ïƒ ]ğ‘…)
  Wlem2ğ‘…ğ‘’ğ‘› ğ‘§ğ‘£ (Ïƒ âŠ• v) = refl
  Wlem2ğ‘…ğ‘’ğ‘› (ğ‘ ğ‘£ v) (Ïƒ âŠ• w) = Wlem2ğ‘…ğ‘’ğ‘› v Ïƒ

  Wlem3ğ‘…ğ‘’ğ‘› : {Î“ Î” Î£ : ctx} {A : ty} (Ïƒ : ren Î” Î£) (Ï„ : ren Î“ Î”) â†’
    Ïƒ âˆ˜ğ‘…ğ‘’ğ‘› Wâ‚ğ‘…ğ‘’ğ‘› A Ï„ â‰¡ Wâ‚ğ‘…ğ‘’ğ‘› A (Ïƒ âˆ˜ğ‘…ğ‘’ğ‘› Ï„)
  Wlem3ğ‘…ğ‘’ğ‘› ! Ï„ = refl
  Wlem3ğ‘…ğ‘’ğ‘› {A = A} (Ïƒ âŠ• v) Ï„ =
    Ïƒ âˆ˜ğ‘…ğ‘’ğ‘› Wâ‚ğ‘…ğ‘’ğ‘› A Ï„ âŠ• v [ Wâ‚ğ‘…ğ‘’ğ‘› A Ï„ ]ğ‘…
      â‰¡âŸ¨ ap (Ïƒ âˆ˜ğ‘…ğ‘’ğ‘› Wâ‚ğ‘…ğ‘’ğ‘› A Ï„ âŠ•_) (Wlem2ğ‘…ğ‘’ğ‘› v Ï„) âŸ©
    Ïƒ âˆ˜ğ‘…ğ‘’ğ‘› Wâ‚ğ‘…ğ‘’ğ‘› A Ï„ âŠ• ğ‘ ğ‘£ (v [ Ï„ ]ğ‘…)
      â‰¡âŸ¨ ap (_âŠ• ğ‘ ğ‘£ (v [ Ï„ ]ğ‘…)) (Wlem3ğ‘…ğ‘’ğ‘› Ïƒ Ï„) âŸ©
    Wâ‚ğ‘…ğ‘’ğ‘› A ((Ïƒ âŠ• v) âˆ˜ğ‘…ğ‘’ğ‘› Ï„)
      âˆ

  Wlem4ğ‘…ğ‘’ğ‘› : {Î“ Î” Î£ : ctx} {A : ty} (Ïƒ : ren Î” Î£) (Ï„ : ren Î“ Î”) â†’
    Wâ‚‚ğ‘…ğ‘’ğ‘› A Ïƒ âˆ˜ğ‘…ğ‘’ğ‘› Wâ‚‚ğ‘…ğ‘’ğ‘› A Ï„ â‰¡ Wâ‚‚ğ‘…ğ‘’ğ‘› A (Ïƒ âˆ˜ğ‘…ğ‘’ğ‘› Ï„)
  Wlem4ğ‘…ğ‘’ğ‘› ! Ï„ = refl
  Wlem4ğ‘…ğ‘’ğ‘› {A = A} (Ïƒ âŠ• v) Ï„ =
    Wâ‚ğ‘…ğ‘’ğ‘› A Ïƒ âˆ˜ğ‘…ğ‘’ğ‘› (Wâ‚ğ‘…ğ‘’ğ‘› A Ï„ âŠ• ğ‘§ğ‘£) âŠ• v [ Wâ‚ğ‘…ğ‘’ğ‘› A Ï„ ]ğ‘… âŠ• ğ‘§ğ‘£
      â‰¡âŸ¨ ap (Î» xÂ â†’ x âŠ• v [ Wâ‚ğ‘…ğ‘’ğ‘› A Ï„ ]ğ‘… âŠ• ğ‘§ğ‘£) (Wlem1ğ‘…ğ‘’ğ‘› Ïƒ (Wâ‚ğ‘…ğ‘’ğ‘› A Ï„) ğ‘§ğ‘£) âŸ©
    Ïƒ âˆ˜ğ‘…ğ‘’ğ‘› Wâ‚ğ‘…ğ‘’ğ‘› A Ï„ âŠ• v [ Wâ‚ğ‘…ğ‘’ğ‘› A Ï„ ]ğ‘… âŠ• ğ‘§ğ‘£
      â‰¡âŸ¨ ap (Î» x â†’ Ïƒ âˆ˜ğ‘…ğ‘’ğ‘› Wâ‚ğ‘…ğ‘’ğ‘› A Ï„ âŠ• x âŠ• ğ‘§ğ‘£) (Wlem2ğ‘…ğ‘’ğ‘› v Ï„) âŸ©
    Ïƒ âˆ˜ğ‘…ğ‘’ğ‘› Wâ‚ğ‘…ğ‘’ğ‘› A Ï„ âŠ• ğ‘ ğ‘£ (v [ Ï„ ]ğ‘…) âŠ• ğ‘§ğ‘£
      â‰¡âŸ¨ ap (Î» xÂ â†’ x âŠ• ğ‘ ğ‘£ (v [ Ï„ ]ğ‘…) âŠ• ğ‘§ğ‘£) (Wlem3ğ‘…ğ‘’ğ‘› Ïƒ Ï„) âŸ©
    Wâ‚‚ğ‘…ğ‘’ğ‘› A ((Ïƒ âŠ• v) âˆ˜ğ‘…ğ‘’ğ‘› Ï„)
      âˆ

  Wlem5ğ‘…ğ‘’ğ‘› : {Î“ Î” Î£ : ctx} {A : ty} (Ïƒ : ren Î” Î£) (Ï„ : ren Î“ Î”) â†’
    Wâ‚ğ‘…ğ‘’ğ‘› A Ïƒ âˆ˜ğ‘…ğ‘’ğ‘› Wâ‚‚ğ‘…ğ‘’ğ‘› A Ï„ â‰¡ Wâ‚ğ‘…ğ‘’ğ‘› A (Ïƒ âˆ˜ğ‘…ğ‘’ğ‘› Ï„)
  Wlem5ğ‘…ğ‘’ğ‘› ! Ï„ = refl
  Wlem5ğ‘…ğ‘’ğ‘› {A = A} (Ïƒ âŠ• v) Ï„ =
    Wâ‚ğ‘…ğ‘’ğ‘› A Ïƒ âˆ˜ğ‘…ğ‘’ğ‘› Wâ‚‚ğ‘…ğ‘’ğ‘› A Ï„ âŠ• v [ Wâ‚ğ‘…ğ‘’ğ‘› A Ï„ ]ğ‘…
      â‰¡âŸ¨ ap (Wâ‚ğ‘…ğ‘’ğ‘› A Ïƒ âˆ˜ğ‘…ğ‘’ğ‘› Wâ‚‚ğ‘…ğ‘’ğ‘› A Ï„ âŠ•_) (Wlem2ğ‘…ğ‘’ğ‘› v Ï„) âŸ©
    Wâ‚ğ‘…ğ‘’ğ‘› A Ïƒ âˆ˜ğ‘…ğ‘’ğ‘› Wâ‚‚ğ‘…ğ‘’ğ‘› A Ï„ âŠ• ğ‘ ğ‘£ (v [ Ï„ ]ğ‘…)
      â‰¡âŸ¨ ap (_âŠ• ğ‘ ğ‘£ (v [ Ï„ ]ğ‘…)) (Wlem5ğ‘…ğ‘’ğ‘› Ïƒ Ï„) âŸ©
    Wâ‚ğ‘…ğ‘’ğ‘› A (Ïƒ âˆ˜ğ‘…ğ‘’ğ‘› Ï„) âŠ• ğ‘ ğ‘£ (v [ Ï„ ]ğ‘…)
      âˆ

  [][]ğ‘…ğ‘’ğ‘› : {Î“ Î” Î£ : ctx} {A : ty} (v : var Î£ A) (Ïƒ : ren Î” Î£) (Ï„ : ren Î“ Î”) â†’
    v [ Ïƒ ]ğ‘… [ Ï„ ]ğ‘… â‰¡ v [ Ïƒ âˆ˜ğ‘…ğ‘’ğ‘› Ï„ ]ğ‘…
  [][]ğ‘…ğ‘’ğ‘› ğ‘§ğ‘£ (Ïƒ âŠ• v) Ï„ = refl
  [][]ğ‘…ğ‘’ğ‘› (ğ‘ ğ‘£ v) (Ïƒ âŠ• w) Ï„ = [][]ğ‘…ğ‘’ğ‘› v Ïƒ Ï„

  âˆ˜ğ‘…ğ‘’ğ‘›Assoc : {Î“ Î” Î£ Î© : ctx} (Ïƒ : ren Î£ Î©) (Ï„ : ren Î” Î£) (Î¼ : ren Î“ Î”) â†’
    Ïƒ âˆ˜ğ‘…ğ‘’ğ‘› Ï„ âˆ˜ğ‘…ğ‘’ğ‘› Î¼ â‰¡ Ïƒ âˆ˜ğ‘…ğ‘’ğ‘› (Ï„ âˆ˜ğ‘…ğ‘’ğ‘› Î¼)
  âˆ˜ğ‘…ğ‘’ğ‘›Assoc ! Ï„ Î¼ = refl
  âˆ˜ğ‘…ğ‘’ğ‘›Assoc (Ïƒ âŠ• v) Ï„ Î¼ =
    Ïƒ âˆ˜ğ‘…ğ‘’ğ‘› Ï„ âˆ˜ğ‘…ğ‘’ğ‘› Î¼ âŠ• v [ Ï„ ]ğ‘… [ Î¼ ]ğ‘…
      â‰¡âŸ¨ ap (Ïƒ âˆ˜ğ‘…ğ‘’ğ‘› Ï„ âˆ˜ğ‘…ğ‘’ğ‘› Î¼ âŠ•_) ([][]ğ‘…ğ‘’ğ‘› v Ï„ Î¼) âŸ©
    Ïƒ âˆ˜ğ‘…ğ‘’ğ‘› Ï„ âˆ˜ğ‘…ğ‘’ğ‘› Î¼ âŠ• v [ Ï„ âˆ˜ğ‘…ğ‘’ğ‘› Î¼ ]ğ‘…
      â‰¡âŸ¨ ap (_âŠ• v [ Ï„ âˆ˜ğ‘…ğ‘’ğ‘› Î¼ ]ğ‘…) (âˆ˜ğ‘…ğ‘’ğ‘›Assoc Ïƒ Ï„ Î¼) âŸ©
    Ïƒ âˆ˜ğ‘…ğ‘’ğ‘› (Ï„ âˆ˜ğ‘…ğ‘’ğ‘› Î¼) âŠ• v [ Ï„ âˆ˜ğ‘…ğ‘’ğ‘› Î¼ ]ğ‘…
      âˆ

  âˆ˜ğ‘…ğ‘’ğ‘›IdL : {Î“ Î” : ctx} (Ïƒ : ren Î“ Î”) â†’ idğ‘…ğ‘’ğ‘› Î” âˆ˜ğ‘…ğ‘’ğ‘› Ïƒ â‰¡ Ïƒ
  âˆ˜ğ‘…ğ‘’ğ‘›IdL ! = refl
  âˆ˜ğ‘…ğ‘’ğ‘›IdL {Î“} {Î” âŠ¹ A} (Ïƒ âŠ• v) =
    Wâ‚ğ‘…ğ‘’ğ‘› A (idğ‘…ğ‘’ğ‘› Î”) âˆ˜ğ‘…ğ‘’ğ‘› (Ïƒ âŠ• v) âŠ• v
      â‰¡âŸ¨ ap (_âŠ• v) (Wlem1ğ‘…ğ‘’ğ‘› (idğ‘…ğ‘’ğ‘› Î”) Ïƒ v) âŸ©
    idğ‘…ğ‘’ğ‘› Î” âˆ˜ğ‘…ğ‘’ğ‘› Ïƒ âŠ• v
      â‰¡âŸ¨ ap (_âŠ• v) (âˆ˜ğ‘…ğ‘’ğ‘›IdL Ïƒ) âŸ©
    Ïƒ âŠ• v
      âˆ

  [id]ğ‘…ğ‘’ğ‘› : {Î“ : ctx} {A : ty} (v : var Î“ A) â†’
    v [ idğ‘…ğ‘’ğ‘› Î“ ]ğ‘… â‰¡ v
  [id]ğ‘…ğ‘’ğ‘› ğ‘§ğ‘£ = refl
  [id]ğ‘…ğ‘’ğ‘› {Î“ âŠ¹ B} {A} (ğ‘ ğ‘£ v) =
    v [ Wâ‚ğ‘…ğ‘’ğ‘› B (idğ‘…ğ‘’ğ‘› Î“) ]ğ‘…
      â‰¡âŸ¨ Wlem2ğ‘…ğ‘’ğ‘› v (idğ‘…ğ‘’ğ‘› Î“) âŸ©
    ğ‘ ğ‘£ (v [ idğ‘…ğ‘’ğ‘› Î“ ]ğ‘…)
      â‰¡âŸ¨ ap ğ‘ ğ‘£ ([id]ğ‘…ğ‘’ğ‘› v) âŸ©
    ğ‘ ğ‘£ v
      âˆ

  âˆ˜ğ‘…ğ‘’ğ‘›IdR : {Î“ Î” : ctx} (Ïƒ : ren Î“ Î”) â†’ Ïƒ âˆ˜ğ‘…ğ‘’ğ‘› idğ‘…ğ‘’ğ‘› Î“ â‰¡ Ïƒ
  âˆ˜ğ‘…ğ‘’ğ‘›IdR ! = refl
  âˆ˜ğ‘…ğ‘’ğ‘›IdR {Î“} (Ïƒ âŠ• v) =
    Ïƒ âˆ˜ğ‘…ğ‘’ğ‘› idğ‘…ğ‘’ğ‘› Î“ âŠ• v [ idğ‘…ğ‘’ğ‘› Î“ ]ğ‘…
      â‰¡âŸ¨ ap (Ïƒ âˆ˜ğ‘…ğ‘’ğ‘› idğ‘…ğ‘’ğ‘› Î“ âŠ•_) ([id]ğ‘…ğ‘’ğ‘› v) âŸ©
    Ïƒ âˆ˜ğ‘…ğ‘’ğ‘› idğ‘…ğ‘’ğ‘› Î“ âŠ• v
      â‰¡âŸ¨ ap (_âŠ• v) (âˆ˜ğ‘…ğ‘’ğ‘›IdR Ïƒ) âŸ©
    Ïƒ âŠ• v
      âˆ

derive : {ty : Type â„“â‚} {tm : ğ¶ğ‘¡ğ‘¥ ty â†’ ty â†’ Type â„“â‚‚} {Î“ Î” : ğ¶ğ‘¡ğ‘¥ ty} {A : ty} â†’
  ğ‘‡ğ‘šğ‘  tm Î“ Î” â†’ ğ‘‰ğ‘ğ‘Ÿ ty Î” A â†’ tm Î“ A
derive Ïƒ ğ‘§ğ‘£ = ğ‘§ğ‘‡ğ‘šğ‘  Ïƒ
derive Ïƒ (ğ‘ ğ‘£ v) = derive (Ï€ğ‘‡ğ‘šğ‘  Ïƒ) v

deriveMap : {ty : Type â„“â‚} {tmâ‚ : ğ¶ğ‘¡ğ‘¥ ty â†’ ty â†’ Type â„“â‚‚} {tmâ‚‚ : ğ¶ğ‘¡ğ‘¥ ty â†’ ty â†’ Type â„“â‚ƒ}
  {Î“ Î” Î£ : ğ¶ğ‘¡ğ‘¥ ty} (f : {A : ty} â†’ tmâ‚ Î“ A â†’ tmâ‚‚ Î” A) (Ïƒ : ğ‘‡ğ‘šğ‘  tmâ‚ Î“ Î£) {A : ty}
  (v : ğ‘‰ğ‘ğ‘Ÿ ty Î£ A) â†’ derive (mapğ‘‡ğ‘šğ‘  {tmâ‚ = tmâ‚} {tmâ‚‚} f Ïƒ) v â‰¡ f (derive Ïƒ v)
deriveMap f (Ïƒ âŠ• t) ğ‘§ğ‘£ = refl
deriveMap f (Ïƒ âŠ• t) (ğ‘ ğ‘£ v) = deriveMap f Ïƒ v
